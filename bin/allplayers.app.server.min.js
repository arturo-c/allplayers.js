/*! allplayers.js 2014-04-25 */
var NO_JQUERY={};!function(a,b,c){if(!("console"in a)){var d=a.console={};d.log=d.warn=d.error=d.debug=function(){}}b===NO_JQUERY&&(b={fn:{},extend:function(){for(var a=arguments[0],b=1,c=arguments.length;c>b;b++){var d=arguments[b];for(var e in d)a[e]=d[e]}return a}}),b.fn.pm=function(){return console.log("usage: \nto send:    $.pm(options)\nto receive: $.pm.bind(type, fn, [origin])"),this},b.pm=a.pm=function(a){e.send(a)},b.pm.bind=a.pm.bind=function(a,b,c,d,f){e.bind(a,b,c,d,f===!0)},b.pm.unbind=a.pm.unbind=function(a,b){e.unbind(a,b)},b.pm.origin=a.pm.origin=null,b.pm.poll=a.pm.poll=200;var e={send:function(a){var c=b.extend({},e.defaults,a),d=c.target;if(!c.target)return void console.warn("postmessage target window required");if(!c.type)return void console.warn("postmessage type required");var f={data:c.data,type:c.type};c.success&&(f.callback=e._callback(c.success)),c.error&&(f.errback=e._callback(c.error)),"postMessage"in d&&!c.hash?(e._bind(),d.postMessage(JSON.stringify(f),c.origin||"*")):(e.hash._bind(),e.hash.send(c,f))},bind:function(a,b,c,d,f){e._replyBind(a,b,c,d,f)},_replyBind:function(c,d,f,g,h){"postMessage"in a&&!g?e._bind():e.hash._bind();var i=e.data("listeners.postmessage");i||(i={},e.data("listeners.postmessage",i));var j=i[c];j||(j=[],i[c]=j),j.push({fn:d,callback:h,origin:f||b.pm.origin})},unbind:function(a,b){var c=e.data("listeners.postmessage");if(c)if(a)if(b){var d=c[a];if(d){for(var f=[],g=0,h=d.length;h>g;g++){var i=d[g];i.fn!==b&&f.push(i)}c[a]=f}}else delete c[a];else for(var g in c)delete c[g]},data:function(a,b){return b===c?e._data[a]:(e._data[a]=b,b)},_data:{},_CHARS:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),_random:function(){for(var a=[],b=0;32>b;b++)a[b]=e._CHARS[0|32*Math.random()];return a.join("")},_callback:function(a){var b=e.data("callbacks.postmessage");b||(b={},e.data("callbacks.postmessage",b));var c=e._random();return b[c]=a,c},_bind:function(){e.data("listening.postmessage")||(a.addEventListener?a.addEventListener("message",e._dispatch,!1):a.attachEvent&&a.attachEvent("onmessage",e._dispatch),e.data("listening.postmessage",1))},_dispatch:function(a){function b(b){c.callback&&e.send({target:a.source,data:b,type:c.callback})}try{var c=JSON.parse(a.data)}catch(d){return void console.warn("postmessage data invalid json: ",d)}if(!c.type)return void console.warn("postmessage message type required");var f=e.data("callbacks.postmessage")||{},g=f[c.type];if(g)g(c.data);else for(var h=e.data("listeners.postmessage")||{},i=h[c.type]||[],j=0,k=i.length;k>j;j++){var l=i[j];if(l.origin&&"*"!==l.origin&&a.origin!==l.origin){if(console.warn("postmessage message origin mismatch",a.origin,l.origin),c.errback){var m={message:"postmessage origin mismatch",origin:[a.origin,l.origin]};e.send({target:a.source,data:m,type:c.errback})}}else try{l.callback?l.fn(c.data,b,a):b(l.fn(c.data,a))}catch(d){if(!c.errback)throw d;e.send({target:a.source,data:d,type:c.errback})}}}};e.hash={send:function(b,c){var d=b.target,f=b.url;if(!f)return void console.warn("postmessage target window url is required");f=e.hash._url(f);var g,h=e.hash._url(a.location.href);if(a==d.parent)g="parent";else try{for(var i=0,j=parent.frames.length;j>i;i++){var k=parent.frames[i];if(k==a){g=i;break}}}catch(l){g=a.name}if(null==g)return void console.warn("postmessage windows must be direct parent/child windows and the child must be available through the parent window.frames list");var m={"x-requested-with":"postmessage",source:{name:g,url:h},postmessage:c},n="#x-postmessage-id="+e._random();d.location=f+n+encodeURIComponent(JSON.stringify(m))},_regex:/^\#x\-postmessage\-id\=(\w{32})/,_regex_len:"#x-postmessage-id=".length+32,_bind:function(){e.data("polling.postmessage")||(setInterval(function(){var b=""+a.location.hash,c=e.hash._regex.exec(b);if(c){var d=c[1];e.hash._last!==d&&(e.hash._last=d,e.hash._dispatch(b.substring(e.hash._regex_len)))}},b.pm.poll||200),e.data("polling.postmessage",1))},_dispatch:function(b){function c(a){f.callback&&e.send({target:i,data:a,type:f.callback,hash:!0,url:b.source.url})}if(b){try{if(b=JSON.parse(decodeURIComponent(b)),!("postmessage"===b["x-requested-with"]&&b.source&&null!=b.source.name&&b.source.url&&b.postmessage))return}catch(d){return}var f=b.postmessage,g=e.data("callbacks.postmessage")||{},h=g[f.type];if(h)h(f.data);else{var i;i="parent"===b.source.name?a.parent:a.frames[b.source.name];for(var j=e.data("listeners.postmessage")||{},k=j[f.type]||[],l=0,m=k.length;m>l;l++){var n=k[l];if(n.origin){var o=/https?\:\/\/[^\/]*/.exec(b.source.url)[0];if("*"!==n.origin&&o!==n.origin){if(console.warn("postmessage message origin mismatch",o,n.origin),f.errback){var p={message:"postmessage origin mismatch",origin:[o,n.origin]};e.send({target:i,data:p,type:f.errback,hash:!0,url:b.source.url})}continue}}try{n.callback?n.fn(f.data,c):c(n.fn(f.data))}catch(d){if(!f.errback)throw d;e.send({target:i,data:d,type:f.errback,hash:!0,url:b.source.url})}}}}},_url:function(a){return(""+a).replace(/#.*$/,"")}},b.extend(e,{defaults:{target:null,url:null,type:null,data:null,success:null,error:null,origin:"*",hash:!1}})}(this,"undefined"==typeof jQuery?NO_JQUERY:jQuery),"JSON"in window&&window.JSON||(JSON={}),function(){function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)d=rep[c],"string"==typeof d&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,b&&"function"!=typeof b&&("object"!=typeof b||"number"!=typeof b.length))throw new Error("JSON.stringify");return str("",{"":a})}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}();var allplayers=allplayers||{};allplayers.app=function(a,b){if(b){a=a||{};for(var c in b)a.hasOwnProperty(c)||(a[c]=b[c]);this.options=a,this.init()}},allplayers.app.getParam=function(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var b="[\\?&]"+a+"=([^&#]*)",c=new RegExp(b),d=c.exec(window.location.search);return null==d?"":decodeURIComponent(d[1].replace(/\+/g," "))},allplayers.app.prototype.init=function(){document.proxy=this};var allplayers=allplayers||{app:{}};!function(a,b,c,d){d&&!d.fn.allplayers_server&&(d.fn.allplayers_server=function(a){return d(this).each(function(){new c.app.server(a,d(this))})}),c.app.server=function(a,b){this.context=b,c.app.call(this,a,{spinner:"",loading:"Loading",base:"https://platform.allplayers.com",type:"registration",group:"api",query:{},reg:{},checkout:{},src:"",style:"",complete:function(){}})},c.app.server.prototype=new c.app,c.app.server.prototype.constructor=c.app.server,c.app.server.prototype.init=function(){c.app.prototype.init.call(this),this.baseURL="https://platform.allplayers.com",this.options.base&&(this.baseURL=this.options.base),this.isLoading=!0,this.options.spinner||(this.options.spinner=this.options.base,this.options.spinner+="/sites/all/themes/basic_foundation",this.options.spinner+="/images/loader.gif"),this.pluginReady=!1;var a=d(b.createElement("div")).css({background:"url("+this.options.spinner+") no-repeat 10px 13px",padding:"10px 10px 10px 60px",width:"100%"});a.append(this.options.loading);var e=this.context.attr("id")+"_iframe",f=function(a){var b;for(b in a)return!1;return!0},g="",h=c.app.getParam("apq");if(h)g=this.options.base+"/"+h;else if(this.options.src)g=this.options.src;else{switch(g=this.options.base+"/g/"+this.options.group,this.options.type){case"registration":g+="/register";break;case"forms":g+="/forms"}this.options.query.etyp=this.options.type}if(g+=-1===g.search(/\?/)?"?":"&",!f(this.options.query))for(var i in this.options.query)g+=i+"="+encodeURIComponent(this.options.query[i]),g+="&";g+="#"+e;var j=this,k=d(b.createElement("iframe")).attr({id:e,name:e,scrolling:"no",seamless:"seamless",width:"100%",height:"0px",src:g}).css({border:"none",overflowY:"hidden"});this.context.append(a),this.context.append(k),this.serverTarget=null,d.pm.bind("chromePluginReady",function(){j.pluginReady=!0}),d.pm.bind("chromeMsgResp",function(a){d.pm({target:j.serverTarget,url:j.baseURL,type:"chromeMsgResp",data:a})}),d.pm.bind("chromeMsg",function(a){d.pm({target:j.serverTarget,url:j.baseURL,type:"chromeMsg",data:a})}),d.pm.bind("init",function(b,c){return j.serverTarget=c.source,j.isLoading=!1,a.remove(),k.height(b.height).attr("height",b.height+"px"),b});var l=function(a){return a.product_uuid&&a.price&&a.quantity&&a.title},m=function(a){return d('input[product="'+a+'"]')},n=function(a){return a.price_raw||(a.price_raw=100*accounting.unformat(a.price)),a.price=accounting.formatMoney(a.price),a.total=accounting.formatMoney(a.price_raw*a.quantity/100),a},o=function(a,b){var c=!0;if(a){a=JSON.parse(a);for(var d=0;d<a.length;d++)if(a[d].title==b.title&&a[d].price_raw==b.price_raw){c=!1,a[d].quantity+=b.quantity,a[d].total=accounting.formatMoney(a[d].price_raw*a[d].quantity/100),b=a[d];break}}else a=[];return c&&a.push(b),p(b),a};c.app.server.prototype.init.processCheckout=function(a,b,c){for(var e=a.commerce_order_total.und[0].amount,f=0;f<b.length;f++)e+=b[f].price_raw;for(f=0;f<c.length;f++)e+=c[f].price_raw;var g=e,h="#edit-commerce-payment-payment-details-amount";d(h)&&(g=100*parseFloat(d(h).val())),d.pm({target:j.serverTarget,url:j.baseURL,type:"processCheckout",data:{checkout:a,adhocProducts:b,existingProducts:c,orderTotal:e,paid:g}})};var p=function(a){var b=!0;a.product_uuid?d("tr#adhoc-product-"+a.product_uuid).length>0&&(d("tr#adhoc-product-"+a.product_uuid+" .quantity").text(a.quantity),d("tr#adhoc-product-"+a.product_uuid+" .total").text(a.total),b=!1):d(".views-table tbody tr").each(function(){var c=d(this).find(".title").text(),e=d(this).find(".price").text();return c&&e&&-1!==c.indexOf(a.title)&&-1!==e.indexOf(a.price)?(d(this).find(".quantity").text(a.quantity),d(this).find(".total").text(a.total),b=!1,!1):void 0}),b&&d(".views-table tbody").append('<tr id="adhoc-product-'+a.product_uuid+'"><td class="title">'+a.title+'</td><td class="seller"></td><td class="price">'+a.price+'</td><td class="quantity">'+a.quantity+'</td><td class="total">'+a.total+"</td></tr>");var c=d("td.component-total"),e=c.text();e=accounting.unformat(e)+a.price_raw/100,e=accounting.formatMoney(e),c.text(e)};d.pm.bind("addProduct",function(a){a&&a.product_uuid?new c.product({uuid:a.product_uuid}).getProduct(a.product_uuid,function(b){if(b.uuid==a.product_uuid){var c=a.product_uuid,e=m(c).val();if(a.title=b.title,e){e=JSON.parse(e),e.quantity=parseInt(e.quantity),e.quantity+=parseInt(a.quantity),m(c).val(JSON.stringify(e));var f="#add-product-display-"+c;d(f+" td:last").text(e.quantity)}else l(a)&&(("undefined"==a.price||"product"==b.type&&b.price_raw>0)&&(a.price=b.price_raw/100),a=n(a),d("<input>").attr({type:"hidden",product:c,name:"add-product[]",value:JSON.stringify(a)}).appendTo("form#og-registration-register-app"),d("#edit-next").val("Continue"),0===d("#add-products-table").length&&(d("<table>").attr({id:"add-products-table","class":"sticky-table"}).appendTo("#add-products"),d("#add-products-table").append("<thead><tr><th>Added Products</th><th>Price</th><th>Quantity</th></tr></thead><tbody></tbody>")),d("#add-products-table tbody").append('<tr id="add-product-display-'+c+'"><td>'+a.title+"</td><td>"+a.price+"</td><td>"+a.quantity+"</td></tr>"))}else alert("There was an error adding the product.")}):(a=n(a),a.title+=" (Adhoc)",d("<input>").attr({type:"hidden",product:"",name:"add-product[]",value:JSON.stringify(a)}).appendTo("form#og-registration-register-app"),d("#edit-next").val("Continue"),0===d("#add-products-table").length&&(d("<table>").attr({id:"add-products-table","class":"sticky-table"}).appendTo("#add-products"),d("#add-products-table").append("<thead><tr><th>Added Products</th><th>Price</th><th>Quantity</th></tr></thead><tbody></tbody>")),d("#add-products-table tbody").append("<tr><td>"+a.title+"</td><td>"+a.price+"</td><td>"+a.quantity+"</td></tr>"))}),d.pm.bind("addCheckoutProduct",function(a){if(a&&a.product_uuid)new c.product({uuid:a.product_uuid}).getProduct(a.product_uuid,function(b){if(b&&b.uuid==a.product_uuid){var c=a.product_uuid,e=m(c).val(),f=d("#add-existing-products-"+j.options.checkout.order_id).val();if(e){e=JSON.parse(e),e.quantity=parseInt(e.quantity),e.quantity+=parseInt(a.quantity),m(c).val(JSON.stringify(e));var g="#adhoc-product-"+c;d(g+" td.quantity").text(e.quantity)}else l(a)&&(("undefined"==a.price||"product"==b.type&&b.price_raw>0)&&(a.price=b.price_raw/100,a.price_raw=b.price_raw),a.title=b.title,a=n(a));f=o(f,a),d("#add-existing-products-"+j.options.checkout.order_id).val(JSON.stringify(f))}else alert("There was an error adding the product.")});else{a=n(a),a.title+=" (Adhoc)";var b=d("#add-adhoc-products-"+j.options.checkout.order_id).val();b=o(b,a),d("#add-adhoc-products-"+j.options.checkout.order_id).val(JSON.stringify(b))}}),d.pm.bind("removeProduct",function(a){var b=a.product_uuid,c=m(b).val();c&&(m(b).remove(),d("#add-product-display-"+b).remove())}),d.pm.bind("clientReady",function(a,b){j.serverTarget=b.source,j.pluginReady&&d.pm({target:b.source,url:j.baseURL,type:"chromePluginReady"}),"registration"==j.options.type?d.pm({target:b.source,url:j.baseURL,type:"getRegistration",data:j.options.reg}):"checkout"==j.options.type&&d.pm({target:b.source,url:j.baseURL,type:"getCheckout",data:j.options.checkout})})}}(window,document,window.allplayers,jQuery);